name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

env:
  PROJECT_ID: bhanufyi
  REGION: us-west1
  REPOSITORY: todo-app
  CLUSTER_NAME: todo-cluster
  CLUSTER_ZONE: us-west1-a
  CACHE_REF: ${{ github.head_ref || github.ref_name }}

jobs:
  checks:
    name: Lint and Typecheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Get pnpm store path
        id: pnpm-store
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> "$GITHUB_OUTPUT"

      - name: Restore pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.STORE_PATH }}
          key: pnpm-${{ runner.os }}-node-22-${{ env.CACHE_REF }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            pnpm-${{ runner.os }}-node-22-${{ env.CACHE_REF }}-
            pnpm-${{ runner.os }}-node-22-main-
            pnpm-${{ runner.os }}-node-22-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Lint (Biome)
        run: pnpm lint:ci

      - name: Commit message lint (PR)
        if: github.event_name == 'pull_request'
        run: pnpm commitlint --from ${{ github.event.pull_request.base.sha }} --to ${{ github.event.pull_request.head.sha }} --verbose

      - name: Commit message lint (push)
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            pnpm commitlint --from HEAD~0 --to HEAD --verbose
          else
            pnpm commitlint --from ${{ github.event.before }} --to ${{ github.sha }} --verbose
          fi

      - name: Typecheck
        run: pnpm typecheck

  build:
    name: Build and Push Images
    needs: checks
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Build API (PR validation)
        if: github.event_name == 'pull_request'
        run: |
          docker build --platform linux/amd64 \
            -t api:pr \
            -f apps/api/Dockerfile .

      - name: Build Web (PR validation)
        if: github.event_name == 'pull_request'
        run: |
          docker build --platform linux/amd64 \
            -t web:pr \
            -f apps/web/Dockerfile .

      - name: Authenticate to Google Cloud
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      - name: Build and Push API (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker build --platform linux/amd64 \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest \
            -f apps/api/Dockerfile .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }}

      - name: Build and Push Web (main)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker build --platform linux/amd64 \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:latest \
            -f apps/web/Dockerfile .
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:${{ github.sha }}

      - name: Push latest tags
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:latest
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:latest

  terraform:
    name: Terraform Apply
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    defaults:
      run:
        working-directory: infrastructure/terraform/02-cloudflare
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.8"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        env:
          TF_VAR_cloudflare_api_token: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          TF_VAR_cloudflare_account_id: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          TF_VAR_cloudflare_zone_id: ${{ secrets.CLOUDFLARE_ZONE_ID }}
          TF_VAR_google_oauth_client_id: ${{ secrets.GOOGLE_OAUTH_CLIENT_ID }}
          TF_VAR_google_oauth_client_secret: ${{ secrets.GOOGLE_OAUTH_CLIENT_SECRET }}
        run: terraform apply -auto-approve

  deploy:
    name: Deploy to GKE
    needs: [build, terraform]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Get GKE credentials
        uses: google-github-actions/get-gke-credentials@v2
        with:
          cluster_name: ${{ env.CLUSTER_NAME }}
          location: ${{ env.CLUSTER_ZONE }}

      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Apply Kubernetes manifests
        run: |
          kubectl kustomize --enable-helm infrastructure/k8s/overlays/production | kubectl apply -f -

      - name: Update image tags
        run: |
          kubectl set image deployment/todo-app-api api=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/api:${{ github.sha }} -n default
          kubectl set image deployment/todo-app-web web=${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPOSITORY }}/web:${{ github.sha }} -n default

      - name: Wait for rollout
        run: |
          kubectl rollout status deployment/todo-app-api -n default --timeout=180s
          kubectl rollout status deployment/todo-app-web -n default --timeout=180s
